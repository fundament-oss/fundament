apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: fundament

# Build configuration for all images
build:
  # Local build settings - load directly into k3d (no registry needed)
  local:
    useBuildkit: true
    concurrency: 0
    push: true

  artifacts:
    - image: authn-api
      context: .
      docker:
        dockerfile: authn-api/Dockerfile

    - image: organization-api
      context: .
      docker:
        dockerfile: organization-api/Dockerfile

    - image: db-migrations
      context: db
      docker:
        dockerfile: Dockerfile

    - image: console-frontend
      context: .
      docker:
        dockerfile: console-frontend/Dockerfile
        buildArgs:
          APP_CONFIGURATION: development
deploy:
  kubeContext: REQUIRES-PROFILE # kubeContext is intentionally invalid to prevent accidental deployments without a profile.
  statusCheckDeadlineSeconds: 300
  helm:
    releases:
      - name: fundament
        chartPath: charts/fundament
        namespace: fundament
        createNamespace: true
        setValueTemplates:
          images.dbMigrations: "{{.IMAGE_FULLY_QUALIFIED_db_migrations}}"
          images.authnApi: "{{.IMAGE_FULLY_QUALIFIED_authn_api}}"
          images.organizationApi: "{{.IMAGE_FULLY_QUALIFIED_organization_api}}"
          images.consoleFrontend: "{{.IMAGE_FULLY_QUALIFIED_console_frontend}}"

profiles:
  - name: env-local
    deploy:
      kubeContext: k3d-fundament
    patches:
      - op: add
        path: /deploy/helm/releases/0/valuesFiles
        value:
          - charts/fundament/values-local.yaml

  - name: env-production
    deploy:
      kubeContext: PRODUCTION-NOT-AVAILABLE-YET
    patches:
      - op: add
        path: /deploy/helm/releases/0/valuesFiles
        value:
          - charts/fundament/values-production.yaml

  # Hot reload profile for local development
  - name: hotreload
    patches:
      - op: replace
        path: /build/artifacts/0/docker/dockerfile
        value: authn-api/hotreload/Dockerfile
      - op: add
        path: /build/artifacts/0/sync
        value: {}
      - op: replace
        path: /build/artifacts/1/docker/dockerfile
        value: organization-api/hotreload/Dockerfile
      - op: add
        path: /build/artifacts/1/sync
        value: {}
      - op: replace
        path: /build/artifacts/3/docker/dockerfile
        value: console-frontend/hotreload/Dockerfile
      - op: add
        path: /build/artifacts/3/sync
        value: {}

# Patch for cluster-worker deployment to use local Gardener
#
# This configures the cluster-worker to connect to a local Gardener
# installation running in a kind cluster.
#
# Known limitations:
# - Shoot names limited to ~15 chars (project + shoot â‰¤ 21 chars)
# - Local provider doesn't support availability zones
# - Requires gardener-kubeconfig secret with internal Docker network IP

apiVersion: apps/v1
kind: Deployment
metadata:
  name: fundament-cluster-worker
spec:
  template:
    spec:
      containers:
        - name: cluster-worker
          env:
            # Switch to real Gardener client
            - name: GARDENER_MODE
              value: "real"

            # Path to kubeconfig (mounted from secret)
            - name: GARDENER_KUBECONFIG
              value: "/etc/gardener/kubeconfig"

            # Local Gardener project namespace
            - name: GARDENER_NAMESPACE
              value: "garden-local"

            # Provider configuration for local setup
            - name: GARDENER_PROVIDER_TYPE
              value: "local"
            - name: GARDENER_CLOUD_PROFILE
              value: "local"
            - name: GARDENER_REGION
              value: "local"

            # Secret binding for provider credentials
            - name: GARDENER_SECRET_BINDING_NAME
              value: "local"

            # Machine configuration for local provider
            - name: GARDENER_MACHINE_TYPE
              value: "local"
            - name: GARDENER_MACHINE_IMAGE_NAME
              value: "local"
            - name: GARDENER_MACHINE_IMAGE_VER
              value: "1.0.0"

            # Kubernetes version for shoots
            - name: GARDENER_KUBERNETES_VERSION
              value: "1.31.1"

            # NOTE: GARDENER_ZONE is intentionally NOT set
            # The local provider doesn't support availability zones

          volumeMounts:
            - name: gardener-kubeconfig
              mountPath: /etc/gardener
              readOnly: true

      volumes:
        - name: gardener-kubeconfig
          secret:
            secretName: gardener-kubeconfig

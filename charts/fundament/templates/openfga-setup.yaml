{{- if $.Values.openfga.enabled }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: openfga-setup
  labels:
    {{- include "fundament.labels" (dict "root" $ "name" "openfga-setup" "component" "backend") | nindent 4 }}
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "fundament.labels" (dict "root" $ "name" "openfga-setup" "component" "backend") | nindent 8 }}
    spec:
      restartPolicy: OnFailure
      serviceAccountName: openfga-setup
      initContainers:
        - name: wait-for-openfga
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for OpenFGA to be ready..."
              until wget -qO- http://openfga:{{ $.Values.openfga.apiPort | default 8080 }}/healthz > /dev/null 2>&1; do
                echo "OpenFGA not ready, waiting..."
                sleep 2
              done
              echo "OpenFGA is ready!"
      containers:
        - name: setup
          image: {{ $.Values.images.openfgaSetup }}
          command:
            - bash
            - -c
            - |
              set -euo pipefail

              export FGA_API_URL="http://openfga:{{ $.Values.openfga.apiPort | default 8080 }}"

              echo "Checking if OpenFGA store already exists..."

              # Check if store already exists
              EXISTING_STORE_ID=$(curl -sf "$FGA_API_URL/stores" | jq -r '.stores[] | select(.name == "fundament") | .id' | head -1)

              if [ -n "$EXISTING_STORE_ID" ]; then
                echo "Store 'fundament' already exists with ID: $EXISTING_STORE_ID"
                export FGA_STORE_ID="$EXISTING_STORE_ID"

                # Get current model ID from configmap (if exists)
                CURRENT_MODEL_ID=$(kubectl get configmap openfga-config -o jsonpath='{.data.authorization-model-id}' 2>/dev/null || echo "")

                # Write the model and get the new model ID
                echo "Writing authorization model..."
                fga model write --store-id "$FGA_STORE_ID" --file /model/model.fga

                NEW_MODEL_ID=$(fga model get --store-id "$FGA_STORE_ID" --field id | sed 's/^# Model ID: //')
                echo "Authorization model ID: $NEW_MODEL_ID"

                if [ "$CURRENT_MODEL_ID" = "$NEW_MODEL_ID" ]; then
                  echo "Model unchanged, no configmap update needed"
                  exit 0
                fi

                echo "Model changed from '$CURRENT_MODEL_ID' to '$NEW_MODEL_ID', updating configmap..."
                MODEL_ID="$NEW_MODEL_ID"
              else
                echo "Creating new store 'fundament' with model..."
                RESULT=$(fga store create --name fundament --model /model/model.fga)
                export FGA_STORE_ID=$(echo "$RESULT" | jq -r '.store.id')
                echo "Store created with ID: $FGA_STORE_ID"

                MODEL_ID=$(fga model get --store-id "$FGA_STORE_ID" --field id | sed 's/^# Model ID: //')
                echo "Authorization model ID: $MODEL_ID"
              fi

              # Write store ID and model ID to a ConfigMap for the organization-api to read
              cat <<ENDOFCM | kubectl apply -f -
              apiVersion: v1
              kind: ConfigMap
              metadata:
                name: openfga-config
                namespace: {{ $.Release.Namespace }}
                labels:
                  {{- include "fundament.labels" (dict "root" $ "name" "openfga" "component" "backend") | nindent 18 }}
              data:
                store-id: "$FGA_STORE_ID"
                authorization-model-id: "$MODEL_ID"
              ENDOFCM

              echo "ConfigMap updated successfully"
          volumeMounts:
            - name: model
              mountPath: /model
      volumes:
        - name: model
          configMap:
            name: openfga-model
{{- end }}

{{- if $.Values.db.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $.Release.Name }}-db-migrations
  labels:
    {{- include "fundament.labels" . | nindent 4 }}
    app.kubernetes.io/component: db-migrations
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/component: db-migrations
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-db
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for database to be ready..."
              until nc -z {{ include "fundament.db.host" . }} 5432; do
                echo "Database not ready, waiting..."
                sleep 2
              done
              echo "Database is ready!"
        - name: migrations
          image: {{ $.Values.images.dbMigrations }}
          command:
            - trek
            - apply
          env:
            - name: TREK_POSTGRES_HOST
              value: {{ include "fundament.db.host" . }}
            - name: TREK_POSTGRES_PORT
              value: "5432"
            - name: TREK_POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: {{ include "fundament.db.superuserSecretName" . }}
                  key: username
            - name: TREK_POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "fundament.db.superuserSecretName" . }}
                  key: password
            - name: TREK_POSTGRES_DATABASE
              value: fundament
            - name: TREK_POSTGRES_SSLMODE
              value: disable
            - name: TREK_RESET_DATABASE
              value: {{ $.Values.db.reset | quote }}
            - name: TREK_INSERT_TEST_DATA
              value: {{ $.Values.db.insertTestData | quote }}
      containers:
        - name: grant-access
          image: ghcr.io/cloudnative-pg/postgresql:18
          command:
            - sh
            - -c
            - |
              set -e
              export PGPASSWORD="$POSTGRES_PASSWORD"
              PGHOST="{{ include "fundament.db.host" . }}"
              PGUSER="$POSTGRES_USER"
              PGDATABASE="fundament"

              # Function to grant database and schema access
              grant_access() {
                ROLE_NAME=$1
                echo "Granting access to $ROLE_NAME..."
                psql -h "$PGHOST" -U "$PGUSER" -d "$PGDATABASE" -c "
                  -- Grant connect to database
                  GRANT CONNECT ON DATABASE fundament TO $ROLE_NAME;

                  -- Grant usage on tenant schema
                  GRANT USAGE ON SCHEMA tenant TO $ROLE_NAME;

                  -- Grant access to all tables in tenant schema
                  GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA tenant TO $ROLE_NAME;

                  -- Grant access to sequences
                  GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA tenant TO $ROLE_NAME;

                  -- Set default privileges for future tables
                  ALTER DEFAULT PRIVILEGES IN SCHEMA tenant
                    GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO $ROLE_NAME;
                  ALTER DEFAULT PRIVILEGES IN SCHEMA tenant
                    GRANT USAGE, SELECT ON SEQUENCES TO $ROLE_NAME;
                "
              }

              # Grant access to each role (roles are managed by CNPG declarative role management)
              grant_access "fun_authn_api"
              grant_access "fun_fundament_api"

              echo "Access granted to all roles!"
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: {{ include "fundament.db.superuserSecretName" . }}
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "fundament.db.superuserSecretName" . }}
                  key: password
---
{{- $authnSecretName := printf "%s-db-fun-authn-api" $.Release.Name }}
{{- $authnExisting := lookup "v1" "Secret" $.Release.Namespace $authnSecretName }}
{{- $authnPassword := "" }}
{{- if $authnExisting }}
{{- $authnPassword = index $authnExisting.data "password" | b64dec }}
{{- else }}
{{- $authnPassword = randAlphaNum 32 }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $authnSecretName }}
  labels:
    {{- include "fundament.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
type: kubernetes.io/basic-auth
stringData:
  username: fun_authn_api
  password: {{ $authnPassword | quote }}
  uri: postgresql://fun_authn_api:{{ $authnPassword }}@{{ include "fundament.db.host" . }}:5432/fundament
---
{{- $fundamentApiSecretName := printf "%s-db-fun-fundament-api" $.Release.Name }}
{{- $fundamentApiExisting := lookup "v1" "Secret" $.Release.Namespace $fundamentApiSecretName }}
{{- $fundamentApiPassword := "" }}
{{- if $fundamentApiExisting }}
{{- $fundamentApiPassword = index $fundamentApiExisting.data "password" | b64dec }}
{{- else }}
{{- $fundamentApiPassword = randAlphaNum 32 }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fundamentApiSecretName }}
  labels:
    {{- include "fundament.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
type: kubernetes.io/basic-auth
stringData:
  username: fun_fundament_api
  password: {{ $fundamentApiPassword | quote }}
  uri: postgresql://fun_fundament_api:{{ $fundamentApiPassword }}@{{ include "fundament.db.host" . }}:5432/fundament
---
{{- $operatorSecretName := printf "%s-db-fun-operator" $.Release.Name }}
{{- $operatorExisting := lookup "v1" "Secret" $.Release.Namespace $operatorSecretName }}
{{- $operatorPassword := "" }}
{{- if $operatorExisting }}
{{- $operatorPassword = index $operatorExisting.data "password" | b64dec }}
{{- else }}
{{- $operatorPassword = randAlphaNum 32 }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $operatorSecretName }}
  labels:
    {{- include "fundament.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
type: kubernetes.io/basic-auth
stringData:
  username: fun_operator
  password: {{ $operatorPassword | quote }}
  uri: postgresql://fun_operator:{{ $operatorPassword }}@{{ include "fundament.db.host" . }}:5432/fundament
{{- end }}

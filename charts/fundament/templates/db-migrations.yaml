{{- if $.Values.db.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $.Release.Name }}-db-migrations
  labels:
    {{- include "fundament.labels" . | nindent 4 }}
    app.kubernetes.io/component: db-migrations
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/component: db-migrations
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-db
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for database to be ready..."
              until nc -z {{ include "fundament.db.host" . }} 5432; do
                echo "Database not ready, waiting..."
                sleep 2
              done
              echo "Database is ready!"
        - name: migrations
          image: {{ $.Values.images.dbMigrations }}
          command:
            - trek
            - apply
          env:
            - name: TREK_POSTGRES_HOST
              value: {{ include "fundament.db.host" . }}
            - name: TREK_POSTGRES_PORT
              value: "5432"
            - name: TREK_POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: {{ include "fundament.db.superuserSecretName" . }}
                  key: username
            - name: TREK_POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "fundament.db.superuserSecretName" . }}
                  key: password
            - name: TREK_POSTGRES_DATABASE
              value: fundament
            - name: TREK_POSTGRES_SSLMODE
              value: disable
            - name: TREK_INSERT_TEST_DATA
              value: "false"
      containers:
        - name: create-roles
          image: ghcr.io/cloudnative-pg/postgresql:18
          command:
            - sh
            - -c
            - |
              set -e
              export PGPASSWORD="$POSTGRES_PASSWORD"
              PGHOST="{{ include "fundament.db.host" . }}"
              PGUSER="$POSTGRES_USER"
              PGDATABASE="fundament"

              # Function to create role if it doesn't exist
              create_role() {
                ROLE_NAME=$1
                ROLE_PASSWORD=$2
                echo "Creating role $ROLE_NAME if it doesn't exist..."
                psql -h "$PGHOST" -U "$PGUSER" -d "$PGDATABASE" -c "
                  DO \$\$
                  BEGIN
                    IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '$ROLE_NAME') THEN
                      CREATE ROLE $ROLE_NAME WITH LOGIN PASSWORD '$ROLE_PASSWORD';
                      RAISE NOTICE 'Role $ROLE_NAME created';
                    ELSE
                      ALTER ROLE $ROLE_NAME WITH PASSWORD '$ROLE_PASSWORD';
                      RAISE NOTICE 'Role $ROLE_NAME already exists, password updated';
                    END IF;
                  END
                  \$\$;
                "
              }

              # Function to grant database and schema access
              grant_access() {
                ROLE_NAME=$1
                echo "Granting access to $ROLE_NAME..."
                psql -h "$PGHOST" -U "$PGUSER" -d "$PGDATABASE" -c "
                  -- Grant connect to database
                  GRANT CONNECT ON DATABASE fundament TO $ROLE_NAME;

                  -- Grant usage on organization schema
                  GRANT USAGE ON SCHEMA organization TO $ROLE_NAME;

                  -- Grant access to all tables in organization schema
                  GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA organization TO $ROLE_NAME;

                  -- Grant access to sequences
                  GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA organization TO $ROLE_NAME;

                  -- Set default privileges for future tables
                  ALTER DEFAULT PRIVILEGES IN SCHEMA organization
                    GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO $ROLE_NAME;
                  ALTER DEFAULT PRIVILEGES IN SCHEMA organization
                    GRANT USAGE, SELECT ON SEQUENCES TO $ROLE_NAME;
                "
              }

              # Create roles
              create_role "fun_authn_api" "$FUN_AUTHN_API_PASSWORD"
              create_role "fun_appstore_api" "$FUN_APPSTORE_API_PASSWORD"
              create_role "fun_organization_api" "$FUN_ORGANIZATION_API_PASSWORD"

              # Grant access to each role
              grant_access "fun_authn_api"
              grant_access "fun_appstore_api"
              grant_access "fun_organization_api"

              echo "All roles created and access granted!"
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: {{ include "fundament.db.superuserSecretName" . }}
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "fundament.db.superuserSecretName" . }}
                  key: password
            - name: FUN_AUTHN_API_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $.Release.Name }}-db-fun-authn-api
                  key: password
            - name: FUN_APPSTORE_API_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $.Release.Name }}-db-fun-appstore-api
                  key: password
            - name: FUN_ORGANIZATION_API_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $.Release.Name }}-db-fun-organization-api
                  key: password
---
{{- $authnSecretName := printf "%s-db-fun-authn-api" $.Release.Name }}
{{- $authnExisting := lookup "v1" "Secret" $.Release.Namespace $authnSecretName }}
{{- $authnPassword := "" }}
{{- if $authnExisting }}
{{- $authnPassword = index $authnExisting.data "password" | b64dec }}
{{- else }}
{{- $authnPassword = randAlphaNum 32 }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $authnSecretName }}
  labels:
    {{- include "fundament.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
type: kubernetes.io/basic-auth
stringData:
  username: fun_authn_api
  password: {{ $authnPassword | quote }}
  uri: postgresql://fun_authn_api:{{ $authnPassword }}@{{ include "fundament.db.host" . }}:5432/fundament?search_path=organization
---
{{- $appstoreSecretName := printf "%s-db-fun-appstore-api" $.Release.Name }}
{{- $appstoreExisting := lookup "v1" "Secret" $.Release.Namespace $appstoreSecretName }}
{{- $appstorePassword := "" }}
{{- if $appstoreExisting }}
{{- $appstorePassword = index $appstoreExisting.data "password" | b64dec }}
{{- else }}
{{- $appstorePassword = randAlphaNum 32 }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $appstoreSecretName }}
  labels:
    {{- include "fundament.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
type: kubernetes.io/basic-auth
stringData:
  username: fun_appstore_api
  password: {{ $appstorePassword | quote }}
  uri: postgresql://fun_appstore_api:{{ $appstorePassword }}@{{ include "fundament.db.host" . }}:5432/fundament?search_path=organization
---
{{- $organizationSecretName := printf "%s-db-fun-organization-api" $.Release.Name }}
{{- $organizationExisting := lookup "v1" "Secret" $.Release.Namespace $organizationSecretName }}
{{- $organizationPassword := "" }}
{{- if $organizationExisting }}
{{- $organizationPassword = index $organizationExisting.data "password" | b64dec }}
{{- else }}
{{- $organizationPassword = randAlphaNum 32 }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $organizationSecretName }}
  labels:
    {{- include "fundament.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
type: kubernetes.io/basic-auth
stringData:
  username: fun_organization_api
  password: {{ $organizationPassword | quote }}
  uri: postgresql://fun_organization_api:{{ $organizationPassword }}@{{ include "fundament.db.host" . }}:5432/fundament?search_path=organization
{{- end }}

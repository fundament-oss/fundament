<!-- Breadcrumb -->
<app-breadcrumb [segments]="breadcrumbSegments" />

<div class="card">
  <!-- Header -->
  <div class="card-header">
    <h1 class="text-2xl font-bold dark:text-white">Namespace permissions</h1>
    <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
      Permissions for {{ namespaceName() }} namespace
    </p>
  </div>

  <div class="p-6">
    <button
      type="button"
      (click)="onAddPermission()"
      class="btn-primary mb-5 inline-flex items-center"
    >
      <ng-icon name="tablerPlus" class="mr-1.5" />
      Add a permission
    </button>

    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th width="40%" scope="col">Name</th>
            <th width="20%" scope="col">Namespace</th>
            <th width="25%" scope="col">Role</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (permission of permissions; track permission.name + permission.namespace) {
            <tr>
              <td class="font-medium dark:text-white">
                {{ permission.name }}
              </td>
              <td>
                {{ permission.namespace }}
              </td>
              <td>
                <span
                  class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-1 text-sm font-medium text-blue-800 dark:bg-blue-950 dark:text-blue-200"
                >
                  {{ permission.role }}
                </span>
              </td>
              <td>
                <button
                  type="button"
                  (click)="onEditPermission(permission, $index)"
                  class="btn-light mr-2 inline-flex shrink-0 items-center"
                >
                  <ng-icon name="tablerPencil" class="mr-1.5" /> Edit
                </button>

                <button
                  type="button"
                  (click)="removePermission($index)"
                  class="btn-remove shrink-0"
                >
                  <ng-icon name="tablerTrash" class="mr-1.5" /> Remove
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Permission Modal -->
<app-modal
  [show]="showModal"
  [title]="isEditMode ? 'Edit permission' : 'Add permission'"
  [maxWidth]="'max-w-lg'"
  (modalClose)="closeModal()"
>
  <form>
    <!-- User Selection (only show when adding) -->
    @if (!isEditMode) {
      <div class="mb-4">
        <label
          for="user-select"
          class="mb-2 block text-sm font-medium text-gray-700 dark:text-white"
        >
          User
        </label>
        <select
          id="user-select"
          [(ngModel)]="selectedUser"
          name="user"
          class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-900 dark:text-white"
        >
          <option value="">Select a user</option>
          @for (user of users; track user) {
            <option [value]="user">{{ user }}</option>
          }
        </select>
      </div>
    }

    <!-- User name (only show when editing) -->
    @if (isEditMode && selectedPermission) {
      <div class="mb-4">
        <span class="mb-2 block text-sm font-medium text-gray-700 dark:text-white">User</span>
        <p class="text-sm dark:text-white">{{ selectedPermission.name }}</p>
      </div>
    }

    <!-- Namespace Selection -->
    <div class="mb-4">
      <label
        for="namespace-select"
        class="mb-2 block text-sm font-medium text-gray-700 dark:text-white"
      >
        Namespace
      </label>
      <select
        id="namespace-select"
        [(ngModel)]="selectedNamespace"
        name="namespace"
        class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-900 dark:text-white"
      >
        <option value="">Select a namespace</option>
        @for (namespace of availableNamespaces; track namespace.name) {
          <option [value]="namespace.name">{{ namespace.name }}</option>
        }
      </select>
    </div>

    <!-- Role Selection -->
    <div class="mb-4">
      <label for="role-select" class="mb-2 block text-sm font-medium text-gray-700 dark:text-white">
        Role
      </label>
      <select
        id="role-select"
        [(ngModel)]="selectedRole"
        name="role"
        class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-900 dark:text-white"
      >
        <option value="">Select a role</option>
        @for (role of availableRoles; track role.name) {
          <option [value]="role.name">{{ role.name }}</option>
        }
      </select>
    </div>

    <div modal-footer class="modal-footer">
      <button type="button" (click)="closeModal()" class="btn-secondary">Cancel</button>
      <button
        type="button"
        (click)="savePermission()"
        [disabled]="!isFormValid()"
        class="btn-primary"
      >
        {{ isEditMode ? 'Save changes' : 'Add permission' }}
      </button>
    </div>
  </form>
</app-modal>

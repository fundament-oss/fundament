<!-- Breadcrumb -->
<nav class="-mt-2 mb-4 flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
  <a routerLink="/plugins" class="hover:text-indigo-600 dark:hover:text-indigo-400">Plugins</a>
  <ng-icon name="tablerChevronRight" size="0.875rem" />
  <span>{{ plugin()?.name || 'Loading...' }}</span>
</nav>

<!-- Loading State -->
@if (isLoading()) {
  <div
    class="rounded-md border border-gray-200 bg-white p-12 text-center dark:border-gray-800 dark:bg-gray-950"
  >
    <div role="status" class="flex justify-center">
      <app-loading-indicator
        class="h-8 w-8 animate-spin fill-indigo-600 text-gray-200 dark:fill-indigo-400 dark:text-gray-800"
      />
      <span class="sr-only">Loading...</span>
    </div>
    <p class="mt-4 text-sm text-gray-600 dark:text-gray-300">Loading plugin details...</p>
  </div>
}

<!-- Error State -->
@if (errorMessage() && !isLoading()) {
  <div class="rounded-md border border-red-200 bg-red-50 p-6 dark:border-red-900 dark:bg-red-950">
    <div class="flex items-center">
      <ng-icon name="tablerCircleXFill" size="1.25rem" class="text-red-600! dark:text-red-400!" />
      <h3 class="ml-3 text-sm font-medium text-red-800 dark:text-red-200">
        {{ errorMessage() }}
      </h3>
    </div>
  </div>
}

<!-- Main Content -->
@if (!isLoading() && !errorMessage() && plugin()) {
  <div class="flex flex-col gap-6 md:flex-row">
    <!-- Main Content -->
    <div class="flex-1">
      <div class="card">
        <!-- Header with Logo and Title -->
        <div class="border-b border-gray-200 px-6 py-6 dark:border-gray-800">
          @if (plugin()) {
            <div class="flex items-center space-x-4">
              <!-- Plugin Logo -->
              <img
                class="flex h-16 w-16 shrink-0 items-center justify-center rounded-full bg-gray-100 p-2 dark:bg-gray-800"
                src="/img/plugins/{{
                  plugin()!
                    .name.toLowerCase()
                    .replace(/[^a-z]+/g, '-')
                }}.svg"
                [alt]="plugin()!.name"
              />

              <!-- Title and Tags -->
              <div class="flex-1">
                <h1 class="text-3xl font-bold dark:text-white">{{ plugin()!.name }}</h1>
                @if (plugin()!.author?.name) {
                  <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                    by {{ plugin()!.author!.name }}
                  </p>
                }
                <div class="mt-2 flex flex-wrap gap-2">
                  @for (tag of plugin()!.tags; track tag.id) {
                    <span
                      [class]="
                        tag.name.toLowerCase() === 'official'
                          ? 'inline-flex items-center rounded-full bg-emerald-100 px-2.5 py-1 text-xs font-medium text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200'
                          : 'inline-flex items-center rounded-full bg-gray-100 px-2.5 py-1 text-xs font-medium text-gray-800 dark:bg-gray-800 dark:text-gray-200'
                      "
                    >
                      @if (tag.name.toLowerCase() === 'official') {
                        <ng-icon name="tablerCheck" size="0.75rem" class="mr-1" />
                      }
                      {{ tag.name }}
                    </span>
                  }
                  @if (hasInstalledClusters()) {
                    <span
                      class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-1 text-xs font-medium text-blue-800 dark:bg-blue-900 dark:text-blue-200"
                    >
                      <ng-icon name="tablerCheck" size="0.75rem" class="mr-1" />
                      Installed on {{ getInstalledClusterCount() }} cluster{{
                        getInstalledClusterCount() > 1 ? 's' : ''
                      }}
                    </span>
                  }
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Description Content -->
        <div class="m-6" [innerHTML]="getRenderedMarkdown()"></div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="md:w-80">
      <div class="sticky top-6">
        <div
          class="mb-6 rounded-md border border-gray-200 bg-white p-6 dark:border-gray-800 dark:bg-gray-950"
        >
          <button
            type="button"
            (click)="openInstallModal()"
            class="btn-primary w-full transition-transform duration-200 ease-in-out hover:-translate-y-px"
          >
            Install plugin
          </button>

          <div class="mt-6 space-y-3 border-t border-gray-200 pt-6 dark:border-gray-800">
            <div class="flex items-start">
              <ng-icon
                name="tablerCheck"
                size="1.25rem"
                class="mr-3 shrink-0 text-emerald-600! dark:text-emerald-400!"
              />
              <span class="text-sm text-gray-600 dark:text-gray-300">Community support</span>
            </div>
            <div class="flex items-start">
              <ng-icon
                name="tablerCheck"
                size="1.25rem"
                class="mr-3 shrink-0 text-emerald-600! dark:text-emerald-400!"
              />
              <span class="text-sm text-gray-600 dark:text-gray-300">Open source</span>
            </div>
            <div class="flex items-start">
              <ng-icon
                name="tablerCheck"
                size="1.25rem"
                class="mr-3 shrink-0 text-emerald-600! dark:text-emerald-400!"
              />
              <span class="text-sm text-gray-600 dark:text-gray-300">Regular updates</span>
            </div>
          </div>
        </div>

        <!-- Additional Information -->
        @if (
          plugin()?.repositoryUrl ||
          plugin()?.documentationLinks?.length ||
          plugin()?.author?.url ||
          (plugin()?.categories && plugin()!.categories.length > 0)
        ) {
          <div
            class="rounded-md border border-gray-200 bg-white p-6 dark:border-gray-800 dark:bg-gray-950"
          >
            <h3 class="mb-2 text-lg font-medium dark:text-white">Categories</h3>

            @if (plugin()?.categories && plugin()!.categories.length > 0) {
              <div class="mb-4 flex flex-wrap gap-2">
                @for (category of plugin()!.categories; track category.id) {
                  <span
                    class="inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-sm text-gray-800 dark:bg-gray-800 dark:text-gray-200"
                  >
                    {{ category.name }}
                  </span>
                }
              </div>
            }

            <h3 class="mb-4 text-lg font-medium dark:text-white">Additional information</h3>
            <div class="space-y-3">
              @if (plugin()!.repositoryUrl) {
                <div>
                  <p class="mb-1 text-xs font-medium text-gray-500 dark:text-gray-400">
                    Repository
                  </p>
                  <a
                    [href]="plugin()!.repositoryUrl"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-sm text-blue-600 underline hover:text-blue-700 hover:no-underline dark:text-blue-400 dark:hover:text-blue-300"
                  >
                    {{ plugin()!.repositoryUrl }}
                  </a>
                </div>
              }
              @if (plugin()!.documentationLinks && plugin()!.documentationLinks.length > 0) {
                <div>
                  <p class="mb-1 text-xs font-medium text-gray-500 dark:text-gray-400">
                    Documentation
                  </p>
                  @for (link of plugin()!.documentationLinks; track link.id) {
                    <a
                      [href]="link.url"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="block text-sm text-blue-600 underline hover:text-blue-700 hover:no-underline dark:text-blue-400 dark:hover:text-blue-300"
                    >
                      {{ link.title }}
                    </a>
                  }
                </div>
              }
              @if (plugin()!.author?.url) {
                <div>
                  <p class="mb-1 text-xs font-medium text-gray-500 dark:text-gray-400">
                    Author website
                  </p>
                  <a
                    [href]="plugin()!.author!.url"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-sm text-blue-600 underline hover:text-blue-700 hover:no-underline dark:text-blue-400 dark:hover:text-blue-300"
                  >
                    {{ plugin()!.author!.url }}
                  </a>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  </div>
}

<!-- Install Modal -->
<app-install-plugin-modal
  [pluginName]="plugin()?.name || ''"
  [clusters]="clusters()"
  [show]="showInstallModal"
  (closeModal)="closeInstallModal()"
  (install)="onInstallOnCluster($event)"
></app-install-plugin-modal>

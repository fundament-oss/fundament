<div class="min-h-screen bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-white">
  <!-- Toast Message -->
  @if (toastService.toast()) {
    <div
      class="fixed right-4 bottom-4 z-100 flex w-sm items-center rounded-md bg-gray-800/90 px-4 py-3 text-sm text-white shadow-lg dark:bg-gray-200/90 dark:text-gray-800"
      role="alert"
    >
      <div
        class="mr-3 rounded-full p-1"
        [class]="
          toastService.toast()?.type === 'success'
            ? 'bg-emerald-400/20 text-emerald-400 dark:bg-emerald-500/20 dark:text-emerald-500'
            : toastService.toast()?.type === 'error'
              ? 'bg-rose-400/20 text-rose-400 dark:bg-rose-500/20 dark:text-rose-500'
              : toastService.toast()?.type === 'warning'
                ? 'bg-amber-400/20 text-amber-400 dark:bg-amber-500/20 dark:text-amber-500'
                : 'bg-indigo-400/20 text-indigo-400 dark:bg-indigo-500/20 dark:text-indigo-500'
        "
      >
        @if (toastService.toast()?.type === 'success') {
          <ng-icon name="tablerCircleCheck" size="1.25rem" class="block!" />
        } @else if (toastService.toast()?.type === 'error') {
          <ng-icon name="tablerCircleX" size="1.25rem" class="block!" />
        } @else if (toastService.toast()?.type === 'warning') {
          <ng-icon name="tablerAlertTriangle" size="1.25rem" class="block!" />
        } @else {
          <ng-icon name="tablerInfoCircle" size="1.25rem" class="block!" />
        }
      </div>
      {{ toastService.toast()?.message }}
      <button
        (click)="toastService.dismiss()"
        type="button"
        aria-label="Dismiss notification"
        class="ml-auto cursor-pointer text-gray-300 hover:text-white dark:text-gray-600 dark:hover:text-gray-800"
      >
        <ng-icon name="tablerX" size="1.25rem" class="block!" />
      </button>
    </div>
  }

  <!-- API Version Mismatch Banner -->
  @if (apiVersionMismatch()) {
    <div
      class="flex items-center justify-between bg-amber-500 px-4 py-3 text-white shadow-md dark:bg-amber-600"
      role="alert"
    >
      <div class="flex items-center">
        <ng-icon name="tablerAlertTriangle" class="mr-3 shrink-0" size="1.5rem" />
        <div>
          <p class="font-semibold">New version available</p>
          <p class="text-sm">The API has been updated. Please reload to use the latest version.</p>
        </div>
      </div>
      <button
        (click)="reloadApp()"
        type="button"
        class="ml-4 shrink-0 cursor-pointer rounded-md bg-white px-4 py-2 text-sm font-medium text-amber-600 transition-colors hover:bg-amber-50 focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-amber-500 focus:outline-none dark:bg-gray-900 dark:text-amber-400 dark:hover:bg-gray-800"
      >
        Reload now
      </button>
    </div>
  }

  <!-- Header -->
  <header class="border-b border-gray-200 bg-white dark:border-gray-800 dark:bg-gray-950">
    <div class="mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between py-4">
        <div class="flex items-center">
          @if (!isLoginPage()) {
            <button
              (click)="toggleSidebar()"
              type="button"
              aria-label="Toggle sidebar"
              class="mr-3 cursor-pointer rounded-md p-2 text-gray-600 ring-indigo-500 hover:bg-gray-100 focus:ring-2 focus:outline-none lg:hidden dark:text-gray-300 dark:ring-offset-gray-950 dark:hover:bg-gray-800"
            >
              <ng-icon name="tablerMenu2" class="block!" size="1.5rem" />
            </button>
          }
          <h1 class="text-2xl font-bold text-indigo-700 dark:text-indigo-300">
            <a class="flex items-center" routerLink="/"
              ><app-fundament-logo-icon class="mr-1.5 h-8 w-8 text-sky-600 dark:text-sky-400" />
              Fundament</a
            >
          </h1>
        </div>

        <!-- Right side dropdown -->
        <div class="-my-1 flex items-center space-x-3">
          <!-- Theme (dark/light mode) Switcher -->
          <button
            (click)="toggleTheme()"
            type="button"
            role="switch"
            aria-label="Toggle dark mode"
            [attr.aria-checked]="isDarkMode()"
            class="group h-6.25 w-10.5 cursor-pointer rounded-full border border-gray-300 bg-gray-200 text-indigo-600 ring-indigo-500 outline-none focus:ring-2 focus:ring-offset-2 focus:outline-none dark:border-gray-700 dark:bg-gray-800 dark:ring-offset-gray-950"
          >
            <span
              class="flex h-5.25 w-5.25 translate-x-0.5 items-center justify-center rounded-full bg-white text-gray-600 shadow transition-transform group-aria-checked:translate-x-4.75 dark:bg-gray-950 dark:text-gray-300"
            >
              @if (isDarkMode()) {
                <ng-icon name="tablerMoon" />
              } @else {
                <ng-icon name="tablerSun" />
              }
            </span>
          </button>

          @if (!isLoginPage()) {
            <!-- User Dropdown -->
            <div class="user-dropdown relative">
              <button
                (click)="toggleUserDropdown()"
                class="flex cursor-pointer items-center rounded-full text-indigo-600 ring-indigo-500 focus:ring-2 focus:outline-none dark:text-indigo-400 dark:ring-offset-gray-950"
                aria-label="User menu"
              >
                <ng-icon name="tablerUserCircle" size="2rem" />
              </button>

              @if (userDropdownOpen()) {
                <div
                  class="absolute right-0 z-10 mt-2 w-48 rounded-md bg-white shadow-lg ring-1 ring-gray-300 dark:bg-gray-950 dark:ring-gray-800"
                >
                  <div class="py-1">
                    <div
                      class="border-b border-gray-100 px-4 py-2 text-sm text-gray-500 dark:border-gray-950 dark:text-gray-300"
                    >
                      Logged in as {{ currentUser()?.name || 'Unknown' }}
                    </div>
                    <a
                      routerLink="/profile"
                      (click)="userDropdownOpen.set(false)"
                      class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-white dark:hover:bg-gray-900"
                    >
                      My profile
                    </a>
                    <a
                      routerLink="/api-keys"
                      (click)="userDropdownOpen.set(false)"
                      class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-white dark:hover:bg-gray-900"
                    >
                      API keys
                    </a>
                    <button
                      (click)="handleLogout()"
                      class="block w-full cursor-pointer px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 dark:text-white dark:hover:bg-gray-900"
                    >
                      Log out
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
  </header>

  @if (showOrgPicker() && !isLoginPage()) {
    <!-- Organization Picker (shown after login for multi-org users) -->
    <app-org-picker
      [organizations]="organizationDataService.userOrganizations()"
      [invitations]="pendingInvitations()"
      (selectOrganization)="handleOrgPickerSelection($event)"
      (acceptInvitation)="handleAcceptInvitation($event)"
      (declineInvitation)="handleDeclineInvitation($event)"
    />
  } @else {
    <div class="flex">
      <!-- Sidebar -->
      @if (!isLoginPage()) {
        <!-- Overlay for mobile -->
        <div
          class="fixed inset-0 z-40 bg-gray-900/50 transition-opacity duration-300 lg:hidden"
          [class.opacity-0]="!sidebarOpen()"
          [class.opacity-100]="sidebarOpen()"
          [class.pointer-events-none]="!sidebarOpen()"
          (click)="closeSidebar()"
          (keydown.escape)="closeSidebar()"
          role="button"
          tabindex="0"
          aria-label="Close sidebar"
        ></div>

        <!-- Sidebar -->
        <aside
          class="fixed inset-y-0 left-0 z-50 w-64 transform border-r border-gray-200 bg-white transition-transform duration-300 ease-in-out lg:static lg:min-h-[calc(100vh-4rem-1px)] lg:translate-x-0 dark:border-gray-800 dark:bg-gray-950"
          [class.-translate-x-full]="!sidebarOpen()"
        >
          <!-- Close button for mobile -->
          <div class="flex justify-end px-4 pt-4 lg:hidden">
            <button
              (click)="closeSidebar()"
              type="button"
              aria-label="Close sidebar"
              class="cursor-pointer rounded-md p-2 text-gray-600 ring-indigo-500 hover:bg-gray-100 focus:ring-2 focus:outline-none dark:text-gray-300 dark:ring-offset-gray-950 dark:hover:bg-gray-800"
            >
              <ng-icon name="tablerX" class="block!" size="1.5rem" />
            </button>
          </div>

          <!-- Selector Button -->
          <div class="px-4 pt-4">
            <!-- Label -->
            <div class="mb-2 px-2 text-xs font-medium text-gray-700 dark:text-gray-300">
              Organization or project:
            </div>

            <!-- Button to open modal -->
            <button
              (click)="openSelectorModal()"
              type="button"
              class="btn-secondary flex w-full items-center"
            >
              <div class="flex min-w-0 flex-1 items-center">
                @if (selectedItemDisplay(); as selected) {
                  @if (selected.type === 'organization') {
                    <ng-icon name="tablerBuilding" class="mr-2 shrink-0" />
                  } @else if (selected.type === 'project') {
                    <ng-icon name="tablerFolder" class="mr-2 shrink-0" />
                  }
                  <span class="truncate">{{ selected.name }}</span>
                } @else {
                  <span class="text-gray-500 dark:text-gray-400">Select...</span>
                }
              </div>
              <ng-icon name="tablerChevronRight" class="ml-2 shrink-0" />
            </button>
          </div>

          <nav class="overflow-y-auto px-4 pb-6">
            @if (selectedType()) {
              <div class="mb-3 pt-5 dark:border-gray-800">
                <p
                  class="px-3 text-xs font-semibold tracking-wider text-gray-500 uppercase dark:text-gray-400"
                >
                  {{ settingsHeader() }}
                </p>
              </div>
            }

            <ul class="space-y-2">
              @if (selectedType() === 'organization') {
                <li>
                  <a
                    routerLink="/"
                    [class.active]="isClustersActive()"
                    class="nav-link"
                    (click)="closeSidebar()"
                  >
                    <app-kubernetes-icon class="mr-3 h-5 w-5" />
                    Clusters
                  </a>
                </li>
                <li>
                  <a
                    routerLink="/projects"
                    routerLinkActive="active"
                    class="nav-link"
                    (click)="closeSidebar()"
                  >
                    <ng-icon name="tablerFolders" class="mr-3" size="1.25rem" />
                    Projects
                  </a>
                </li>
                <li>
                  <a
                    routerLink="/plugins"
                    routerLinkActive="active"
                    class="nav-link"
                    (click)="closeSidebar()"
                  >
                    <ng-icon name="tablerPuzzle" class="mr-3" size="1.25rem" />
                    Plugins
                  </a>
                </li>
                <li>
                  <a
                    routerLink="/organization/members"
                    routerLinkActive="active"
                    class="nav-link"
                    (click)="closeSidebar()"
                  >
                    <ng-icon name="tablerUsers" class="mr-3" size="1.25rem" />
                    Members
                  </a>
                </li>
                <li>
                  <a
                    routerLink="/usage"
                    routerLinkActive="active"
                    class="nav-link"
                    (click)="closeSidebar()"
                  >
                    <ng-icon name="tablerChartLine" class="mr-3" size="1.25rem" />
                    Usage
                  </a>
                </li>
                <li>
                  <a
                    routerLink="/organization"
                    routerLinkActive="active"
                    [routerLinkActiveOptions]="{ exact: true }"
                    class="nav-link"
                    (click)="closeSidebar()"
                  >
                    <ng-icon name="tablerSettings" class="mr-3" size="1.25rem" />
                    Settings
                  </a>
                </li>
              } @else if (selectedType() === 'project') {
                <li>
                  <a
                    [routerLink]="['/projects', selectedProjectId()]"
                    routerLinkActive="active"
                    [routerLinkActiveOptions]="{ exact: true }"
                    class="nav-link"
                    (click)="closeSidebar()"
                  >
                    <ng-icon name="tablerFolder" size="1.25rem" class="mr-3" />
                    General
                  </a>
                </li>
                <li>
                  <a
                    [routerLink]="['/projects', selectedProjectId(), 'namespaces']"
                    routerLinkActive="active"
                    class="nav-link"
                    (click)="closeSidebar()"
                  >
                    <ng-icon name="tablerBracketsContain" size="1.25rem" class="mr-3" />
                    Namespaces
                  </a>
                </li>
                <li>
                  <a
                    [routerLink]="['/projects', selectedProjectId(), 'members']"
                    routerLinkActive="active"
                    class="nav-link"
                    (click)="closeSidebar()"
                  >
                    <ng-icon name="tablerUsers" class="mr-3" size="1.25rem" />
                    Members
                  </a>
                </li>
                <li>
                  <a
                    [routerLink]="['/projects', selectedProjectId(), 'usage']"
                    routerLinkActive="active"
                    class="nav-link"
                    (click)="closeSidebar()"
                  >
                    <ng-icon name="tablerChartLine" class="mr-3" size="1.25rem" />
                    Usage
                  </a>
                </li>
                <li>
                  <a
                    [routerLink]="['/projects', selectedProjectId(), 'settings']"
                    routerLinkActive="active"
                    class="nav-link"
                    (click)="closeSidebar()"
                  >
                    <ng-icon name="tablerSettings" class="mr-3" size="1.25rem" />
                    Settings
                  </a>
                </li>
              }
            </ul>
          </nav>
        </aside>
      }

      <!-- Main Content (deferred until an organization is selected, to avoid API calls without Fun-Organization header) -->
      <main class="mx-auto max-w-7xl min-w-0 flex-1 px-4 py-6 sm:px-6">
        @if (isLoginPage() || selectedOrgId() || selectedProjectId()) {
          @if (!isLoginPage()) {
            <app-breadcrumb [segments]="breadcrumbSegments()" />
          }
          <router-outlet />
        }
      </main>
    </div>

    <!-- Selector Modal -->
    <app-selector-modal
      [show]="selectorModalOpen()"
      [organizations]="selectorOrganizations()"
      [selectedOrgId]="selectedOrgId()"
      [selectedProjectId]="selectedProjectId()"
      (closeModal)="closeSelectorModal()"
      (selectOrganization)="selectOrganization($event)"
      (selectProject)="selectProjectItem($event)"
    />
  }
</div>

<!-- Header -->
<div class="card-header">
  <h1 class="text-2xl font-bold dark:text-white">Cluster summary</h1>
  <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
    Review your cluster configuration before creating it.
  </p>
</div>

<!-- Summary Content -->
<div class="space-y-6 px-6 py-6">
  <!-- Basics Block -->
  <div class="rounded-md border border-gray-200 p-4 dark:border-gray-800">
    <h3 class="mb-4 text-lg font-medium dark:text-white">Basics</h3>
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
      <dl>
        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Cluster name</dt>
        <dd class="mt-1 text-sm dark:text-white">{{ state().clusterName || 'N/A' }}</dd>
      </dl>
      <dl>
        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Region</dt>
        <dd class="mt-1 text-sm dark:text-white">{{ state().region?.toUpperCase() || 'N/A' }}</dd>
      </dl>
      <dl>
        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Kubernetes version</dt>
        <dd class="mt-1 text-sm dark:text-white">
          {{ state().kubernetesVersion || 'N/A' }}
        </dd>
      </dl>
    </div>
  </div>

  <!-- Node Pools Block -->
  <div class="rounded-md border border-gray-200 p-4 dark:border-gray-800">
    <h3 class="mb-4 text-lg font-medium dark:text-white">Node pools</h3>
    @if (state().nodePools && state().nodePools!.length > 0) {
      <div class="space-y-4">
        @for (nodePool of state().nodePools; track nodePool.name) {
          <div
            class="rounded-md border border-gray-200 bg-gray-50 p-3 dark:border-gray-800 dark:bg-gray-900"
          >
            <h4 class="mb-3 text-sm font-medium dark:text-white">{{ nodePool.name }}</h4>
            <div class="grid grid-cols-1 gap-3 sm:grid-cols-3">
              <dl>
                <dt class="text-xs font-medium text-gray-500 dark:text-gray-400">Machine type</dt>
                <dd class="mt-1 text-sm dark:text-white">{{ nodePool.machineType }}</dd>
              </dl>
              <dl>
                <dt class="text-xs font-medium text-gray-500 dark:text-gray-400">
                  Min autoscaling
                </dt>
                <dd class="mt-1 text-sm dark:text-white">{{ nodePool.autoscaleMin }} nodes</dd>
              </dl>
              <dl>
                <dt class="text-xs font-medium text-gray-500 dark:text-gray-400">
                  Max autoscaling
                </dt>
                <dd class="mt-1 text-sm dark:text-white">{{ nodePool.autoscaleMax }} nodes</dd>
              </dl>
            </div>
          </div>
        }
      </div>
    } @else {
      <p class="text-sm text-gray-500 dark:text-gray-400">No node pools configured</p>
    }
  </div>

  <!-- Plugins Block -->
  <div class="rounded-md border border-gray-200 p-4 dark:border-gray-800">
    <h3 class="mb-4 text-lg font-medium dark:text-white">Plugins</h3>
    @if (isLoadingPlugins()) {
      <p class="text-sm text-gray-500 dark:text-gray-400">Loading plugin information...</p>
    } @else if (state().preset || (state().plugins && state().plugins!.length > 0)) {
      <div class="space-y-2">
        @if (state().preset) {
          <dl>
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Preset</dt>
            <dd class="mt-1 text-sm dark:text-white">{{ getPresetName(state().preset!) }}</dd>
          </dl>
        }
        @if (state().plugins && state().plugins!.length > 0) {
          <dl>
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Selected plugins</dt>
            <dd class="mt-2 flex flex-wrap gap-1">
              @for (pluginName of getPluginNames(state().plugins!); track pluginName) {
                <span
                  class="inline-flex items-center rounded-md bg-emerald-100 px-2 py-1 text-xs font-medium text-emerald-800 dark:bg-emerald-950 dark:text-emerald-200"
                >
                  {{ pluginName }}
                </span>
              }
            </dd>
          </dl>
        }
      </div>
    } @else {
      <p class="text-sm text-gray-500 dark:text-gray-400">No plugins configured</p>
    }
  </div>

  <!-- Error Message -->
  @if (errorMessage()) {
    <div class="flex items-center rounded-md bg-rose-50 p-4 dark:bg-rose-900/20">
      <ng-icon
        name="tablerCircleXFill"
        class="mr-3 shrink-0 text-rose-400! dark:text-rose-500!"
        size="1.25rem"
      />
      <p class="text-sm font-medium text-rose-800 dark:text-rose-200">{{ errorMessage() }}</p>
    </div>
  }

  <!-- Form Actions -->
  <div class="flex space-x-3 border-t border-gray-200 pt-6 dark:border-gray-800">
    <a
      routerLink="/clusters/add/plugins"
      class="btn-secondary"
      [class.pointer-events-none]="isCreating() || showModal()"
      [class.opacity-50]="isCreating() || showModal()"
      >Previous step</a
    >
    <button
      type="button"
      (click)="onCreateCluster()"
      class="btn-primary"
      [disabled]="isCreating() || showModal()"
    >
      {{ isCreating() ? 'Creating...' : 'Create cluster' }}
    </button>
  </div>
</div>

<!-- Creation Progress Modal -->
<app-modal
  [show]="showModal()"
  title="Creating cluster"
  (modalClose)="onModalClose()"
  maxWidth="max-w-lg"
>
  <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">
    Your cluster is being provisioned. You can track the progress of each step below.
  </p>
  <div class="max-h-[60vh] divide-y divide-gray-200 overflow-y-auto dark:divide-gray-800">
    @for (item of progressItems(); track item.key) {
      <div class="flex items-center justify-between gap-1 py-3">
        <div class="flex items-center space-x-3">
          <!-- Status icon -->
          @if (item.requestStatus === 'pending') {
            <div
              class="h-5 w-5 shrink-0 rounded-full border-2 border-gray-300 dark:border-gray-600"
            ></div>
          } @else if (
            item.requestStatus === 'in_progress' ||
            (item.requestStatus === 'succeeded' && item.syncStatus === 'syncing')
          ) {
            <app-loading-indicator
              class="h-5 w-5 shrink-0 animate-spin fill-indigo-600 text-gray-200 dark:fill-indigo-400 dark:text-gray-800"
            />
          } @else if (item.requestStatus === 'failed' || item.syncStatus === 'failed') {
            <ng-icon name="tablerCircleXFill" class="shrink-0 text-rose-500!" size="1.25rem" />
          } @else {
            <ng-icon name="tablerCircleCheck" class="shrink-0 text-green-500!" size="1.25rem" />
          }

          <div>
            <p class="text-sm font-medium dark:text-white">
              @if (item.type === 'nodepool') {
                <span class="text-gray-500 dark:text-gray-400">Node pool:</span>
              } @else if (item.type === 'plugin') {
                <span class="text-gray-500 dark:text-gray-400">Plugin:</span>
              }
              {{ item.name }}
            </p>
            @if (item.requestStatus === 'pending') {
              <p class="text-xs text-gray-500 dark:text-gray-400">Waiting...</p>
            } @else if (item.requestStatus === 'in_progress') {
              <p class="text-xs text-indigo-600 dark:text-indigo-400">
                {{ item.type === 'plugin' ? 'Installing...' : 'Creating...' }}
              </p>
            } @else if (item.requestStatus === 'failed') {
              <p class="text-xs text-rose-600 dark:text-rose-400">{{ item.error }}</p>
            } @else if (item.syncStatus === 'syncing') {
              <p class="text-xs text-indigo-600 dark:text-indigo-400">
                Syncing{{ item.shootStatus ? ' (' + item.shootStatus + ')' : '' }}...
              </p>
            } @else if (item.syncStatus === 'failed') {
              <p class="text-xs text-rose-600 dark:text-rose-400">{{ item.error }}</p>
            } @else if (item.syncStatus === 'synced') {
              <p class="text-xs text-green-600 dark:text-green-400">Ready</p>
            } @else {
              <p class="text-xs text-green-600 dark:text-green-400">
                {{ item.type === 'plugin' ? 'Installed' : 'Done' }}
              </p>
            }
          </div>
        </div>

        @if (item.requestStatus === 'failed') {
          <button
            type="button"
            (click)="retryItem(item.key)"
            class="btn-light flex items-center gap-1 px-2! py-1! text-xs!"
          >
            <ng-icon name="tablerArrowBackUp" size="1rem" />
            Retry
          </button>
        }
      </div>
    }
  </div>

  <div modal-footer class="mt-6">
    @if (clusterId()) {
      <button type="button" (click)="navigateToCluster()" class="btn-primary">Go to cluster</button>
    } @else if (!isCreating()) {
      <button type="button" (click)="onModalClose()" class="btn-secondary">Cancel</button>
    }
  </div>
</app-modal>
